version: v1.0
name: First pipeline example
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: 'Compile'
    task:
      env_vars:
        - name: API_BASE_URL
          value: https://xqksrj7oo8.execute-api.ap-southeast-2.amazonaws.com/dev/
        - name: NODE_ENV
          value: production
      jobs:
        - name: client
          commands:
            - checkout
            - echo "Building client"
            # Reuse dependencies from cache and avoid installing them from scratch:
            # - cache restore node-modules-$(checksum yarn.lock)
            - yarn
            - yarn build
            # - cache store node-modules-$(checksum yarn.lock) node_modules
            # - cache store client-dist dist
        - name: api
          commands:
            - echo "Building api"
            - cd client
            - yarn
            - yarn build
  # - name: 'Test'
  #   task:
  #     jobs:
  #       - name: Smoke
  #         commands:
  #           - checkout
  #           - echo "make smoke"
  # - name: 'Deploy'
  #   task:
  #     jobs:
  #       - name: RSpec
  #         commands:
  #           - checkout
  #           - echo "make rspec"
  #       - name: Lint code
  #         commands:
  #           - checkout
  #           - echo "make lint"
  #       - name: Check security
  #         commands:
  #           - checkout
  #           - echo "make security"
promotions:
  - name: Production deploy
    pipeline_file: production-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
