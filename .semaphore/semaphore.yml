version: v1.0
name: HMB compile and test pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: 'Compile'
    task:
      # prologue:
      #   commands:
      #     - yarn global add typescript
      env_vars:
        - name: API_BASE_URL
          value: https://xqksrj7oo8.execute-api.ap-southeast-2.amazonaws.com/dev/
        - name: NODE_ENV
          value: production
      jobs:
        - name: client
          commands:
            - echo "Building client"
            - checkout
            # Reuse dependencies from cache and avoid installing them from scratch:
            - cd client
            # - cache restore node-modules-$(checksum yarn.lock)
            - yarn --production=false # don't ignore the dev dependencies
            - yarn build
            # - cache store node-modules-$(checksum yarn.lock) node_modules
            # - cache store client-dist dist
        # - name: api
        #   commands:
        #     - echo "Building api"
        #     - checkout
        #     - cd api
        #     # - cache restore node-modules-$(checksum yarn.lock)
        #     - yarn --production=false
        #     # - cache store node-modules-$(checksum yarn.lock) node_modules
        #     - yarn package
  # - name: 'Test'
  #   task:
  #     jobs:
  #       - name: Smoke
  #         commands:
  #           - checkout
  #           - echo "make smoke"
  # - name: 'Deploy'
  #   task:
  #     jobs:
  #       - name: RSpec
  #         commands:
  #           - checkout
  #           - echo "make rspec"
  #       - name: Lint code
  #         commands:
  #           - checkout
  #           - echo "make lint"
  #       - name: Check security
  #         commands:
  #           - checkout
  #           - echo "make security"
promotions:
  - name: Deploy PRODUCTION
    pipeline_file: production-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
