version: v1.0
name: HMB compile and test pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: 'Compile'
    task:
      # prologue:
      #   commands:
      #     -
      env_vars:
        - name: API_BASE_URL
          value: https://xqksrj7oo8.execute-api.ap-southeast-2.amazonaws.com/dev/
        - name: NODE_ENV
          value: production
      jobs:
        - name: client
          commands:
            - printenv
            - echo "Building client"
            - checkout
            - cd client
            # For speed: cache restore/store node modules
            - cache restore node-modules-$(checksum package-json.lock)
            - npm i --production=false # don't ignore the dev dependencies
            - npm run build
            - cache store node-modules-$(checksum package-json.lock) node_modules
            # used in production-deploy pipeline, use yarn lock as source of state
            - cache store client-dist-$SEMAPHORE_WORKFLOW_ID dist
            - cache store client-scripts-$SEMAPHORE_WORKFLOW_ID scripts
        - name: api
          commands:
            - echo "Building api"
            - checkout
            - cd api
            - cache restore node-modules-$(checksum yarn.lock)
            - yarn --production=false
            - cache store node-modules-$(checksum yarn.lock) node_modules
            - yarn test
            - yarn package
            # used in production-deploy pipeline, use serverless-state as source of state?
            - cache store serverless-build-$SEMAPHORE_WORKFLOW_ID .serverless
            - cache store api-node-modules-$SEMAPHORE_WORKFLOW_ID node_modules

# why not different pipelines: deploy portal, deploy api, deploy all
promotions:
  - name: Deploy production
    pipeline_file: production-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
